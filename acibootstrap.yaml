---
#- name: ACIBOOTSTRAP Get APIC Creds
#  hosts: localhost
#  gather_facts: no
#  vars_prompt:
#    - name: apic_ip
#      prompt: "Enter APIC IP"
#      private: no
#      required: yes
#
#    - name: user
#      prompt: "Enter APIC Username"
#      private: no
#      default: "admin"
#      prompt: "Enter APIC Password"
#      private: no
#
#  tasks:
#    - add_host:
#        name: "{{ apic_ip }}"
#        groups: apic
#    - set_fact:
#        user: "{{ user }}"

- name: ACIBOOTSTRAP Fabric Entities
  hosts: apic
  connection: local
  gather_facts: no
  vars_files:
    - acibootstrap/files/vars/acibootstrap_vars.yml
    - acibootstrap/files/vars/static_vars.yml


  #include_vars: var/fabric.yml

  tasks:
    - name: debug
      debug: msg="{{ vars }}"

    - name: Gather Controller ID's
      aci_fabricNodeID.py: host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }} role="controller"
      register: controllers

    - name: Gather Leaf ID's
      aci_fabricNodeID.py: host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }} role="leaf"

    - name: Get list of Spine ID's
      aci_spine_id.py: host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
      register: spines

    #This section focuses on Interface Policies that should exist and can be consumed elsewhere
    - name: install CDP_ENABLE
      aci_rest: action=post uri=/api/mo/uni.json config_file=acibootstrap/files/configs/static/cdpIfP-CDP_ENABLE.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install CDP_DISABLE
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/static/cdpIfP-CDP_DISABLE.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: install LLDP_ENABLE
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/static/lldpIfP-LLDP_ENABLE.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install LLDP_DISABLE
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/static/lldpIfP-LLDP_DISABLE.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: install Port Channel LACP_ACTIVE
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/static/lacplagp-LACP_ACTIVE.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install Port Channel MAC_PINNING
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/static/lacplagp-MAC_PINNING.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create Port Channel Mode On
      template: src=acibootstrap/files/configs/templates/lacplagp-MODE_ON.j2 dest=acibootstrap/files/configs/dynamic/lacplagp-MODE_ON.json
    - name: install Port Channel Mode On
      aci_rest: action=post uri=/api/mo/uni.json config_file=acibootstrap/files/configs/dynamic/lacplagp-MODE_ON.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create Link Level policies
      template: src=acibootstrap/files/configs/templates/hintfpol-.j2 dest=acibootstrap/files/configs/custom/hintfpol-{{ item }}.json
      with_items: "{{ speeds }}"

    - name: install Link Level policies
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/custom/hintfpol-{{ item }}.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
      with_items: "{{ speeds }}"

    - name: create STP BPDU policies
      template: src=acibootstrap/files/configs/templates/ifPol-bpdu-.j2 dest=acibootstrap/files/configs/dynamic/ifPol-{{ item }}_ON.json
      with_items: "{{ stp_bpdu }}"
    - name: install STP BPDU policies
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/dynamic/ifPol-{{ item }}_ON.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
      with_items: "{{ stp_bpdu }}"


    # Obtain a list of ACI Spines, then install BGP RRs


    - name: Ensure we got spine list (for debugging only)
      debug: var=spines.response

    - name: Create Fabric BGP RR policy
      template: src={{ templates }}/bgpInstP-default.j2 dest={{ dynamic }}/bgpInstP-default-{{ item }}.json
      with_items: "{{ spines.response }}"

    - name: Install Fabric BGP RR policy
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/bgpInstP-default-{{ item }}.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
      with_items: "{{ spines.response }}"


    - name: create STP ON policy
      template: src=acibootstrap/files/configs/templates/ifPol-stp-ON.j2 dest=acibootstrap/files/configs/dynamic/ifPol-stp-ON.json
    - name: install STP ON policy
      aci_rest: action=post uri=api/mo/uni.json config_file=acibootstrap/files/configs/dynamic/ifPol-stp-ON.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create date/time default
      template: src=acibootstrap/files/configs/templates/format-default.j2 dest=acibootstrap/files/configs/dynamic/format-default.json
    - name: install date/time default (setting tz)
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/format-default.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create time default policy
      template: src={{ templates }}/time-default.j2 dest={{ dynamic }}/time-default.json
    - name: install time default policy
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/time-default.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create dns domain policy
      template: src={{ templates }}/dom-.j2 dest={{ dynamic }}/dom-{{ domain }}.json
    - name: install dns domain policy
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/dom-{{ domain }}.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create dns provider policy
      template: src={{ templates }}/prov-.j2 dest={{ dynamic }}/prov-{{dns}}.json
    - name: install dns provider policy
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/prov-{{dns}}.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: set dns default policy to use oob-default
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/dnsp-default.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: set Fabric L2 MTU policy to 9000
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/l2pol-default.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: install VPC policy
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/protpol.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}



    # Install Common Contracts and Filters
    - name: create ALLOW_ALL filter
      template: src={{ templates }}/flt-ALLOW_ALL.j2 dest={{ dynamic }}/flt-ALLOW_ALL.json
    - name: install ALLOW_ALL filter
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/flt-ALLOW_ALL.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create web filter
      template: src={{ templates }}/flt-web.j2 dest={{ dynamic }}/flt-web.json
    - name: install web filter
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/flt-web.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}


    # Setup VMM integration
    - name: create vmm pool
      template: src={{ templates}}/vlans-dynamic.j2 dest={{ dynamic}}/vlans-{{ vmmpool }}-dynamic.json
    - name: install vmm pool
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/vlans-{{ vmmpool }}-dynamic.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}



    # Setup Physical interfaces
    # Setup UCS FI Shared objects
    - name: install svr bm vlan pool
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/vlanns-[svr-bm-vlans]-dynamic.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install ucs physical domain
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/phys-svr.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install ucs attachable entity profile
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/attentp-svr.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    # Setup FI A
    - name: install VPC interface policy group for UCS FI A
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/accbundle-ucs-fi-a.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install interface policy for E1/1 (UCS FI A)
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/accportprof-e1-1.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    # Create and Install L3-router
    - name: install L3-router-out vlan pool
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/vlanns-[L3-router-out]-dynamic.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install L3 router Physical Domain
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/phys-router.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install L3 router Attachable Entity Profile
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/attentp-router.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: create interface policy group for L3 router
      template: src={{ templates }}/accportgrp-L3-router-out.j2 dest={{ dynamic }}/accportgrp-L3-router-out.json
    - name: install interface policy group for L3 router
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/accportgrp-L3-router-out.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install interface policy for E1/30 (L3 router)
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/accportprof-e1-30.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    # Create and install switches and ports to those switches
    - name: install VPC switch pair profile with interfaces
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/nprof-leaf_101_102.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}


    # Install L3 POC tenant.name
    - name: create {{ tenant.name }}-POC tenant
      template: src={{ templates }}/tn-poc-L3.j2 dest={{ dynamic }}/tn-{{ tenant.name }}-POC.json
    - name: install {{ tenant.name }}-POC tenant
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/tn-{{tenant.name}}-POC.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}

    - name: create External subnets for {{ tenant.name }}-POC
      template: src={{ templates }}/subnet-POC-external.j2 dest={{ dynamic }}/subnet-{{ item.name }}-external.json
      with_items: "{{ tenant.external_subnets }}"
    - name: install External subnets
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/subnet-{{ item.name }}-external.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
      with_items: "{{ tenant.external_subnets }}"

    - name: create Internal subnets for {{ tenant.name }}-POC
      template: src={{ templates }}/subnet-POC-private.j2 dest={{ dynamic }}/subnet-{{ item.name }}-internal.json
      with_items: "{{ tenant.private_subnets }}"
    - name: install Internal subnets
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/subnet-{{ item.name }}-internal.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
      with_items: "{{ tenant.private_subnets}}"


    # Setup MGMT tenant with OOB stuff
    - name: create mgmt oob pool
      template: src={{ templates }}/addrinst-oobaddr.j2 dest={{ dynamic }}/addrinst-oobaddr.json
    - name: install mgmt oob pool
      aci_rest: action=post uri=api/mo/uni.json config_file={{ dynamic }}/addrinst-oobaddr.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install mgmt Node Management Addresses
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/mgmtnodegrp-switch-oob.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}
    - name: install mgmt Managed Node Connectivity Group
      aci_rest: action=post uri=api/mo/uni.json config_file={{ static }}/grp-switch-oob.json host={{ inventory_hostname }} username={{ user }} password={{ pass }} protocol={{ protocol }}


#- name: ACIBOOTSTRAP Local Cleanup
#  hosts: localhost
#  gather_facts: no

#  tasks:
#    - name: Delete Custom Configs
#      file:
#        state: absent
#        path: "acibootstrap/files/configs/custom/"
#    - name: Create Empty Custom Configs folder
#      file:
#        state: directory
#        path: "acibootstrap/files/configs/custom/"
#    - name: Delete Dynamic Configs
#      file:
#        state: absent
#        path: "acibootstrap/files/configs/dynamic/"
#    - name: Create Empty Dynamic Configs folder
#      file:
#        state: directory
#        path: "acibootstrap/files/configs/dynamic/"
